<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Escaneo de Belt - EVE Online V1.2</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f0f10; --panel:#161616; --muted:#9ea1a4; --accent:#4caf50; --card:#1c1c1c; --text:#e9eef2;
      --tritanium:#ffeb3b;    /* amarillo */
      --pyerite:#ff9800;      /* naranja */
      --nocxium:#6f6f74;      /* gris oscuro */
      --mexallon:#a7f432;     /* verde lima */
      --megacyte:#c0c0c8;     /* plata claro */
      --isogen:#00b0ff;       /* azul elÃ©ctrico */
      --morphite:#b3002d;     /* ruby (rojo) */
      --zydrine:#00c27a;      /* verde esmeralda brillante */
      --default-raw:#d0d0d0;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;}
    .app{box-sizing:border-box; padding:18px; display:flex; flex-direction:column; gap:16px; min-height:100vh;}
    .cols{display:flex; gap:16px;}
    .left,.right{background:var(--panel); border:1px solid #222; border-radius:8px; padding:14px; box-sizing:border-box;}
    .left{flex:1 1 50%; min-width:320px;}
    .right{flex:1 1 50%; min-width:320px; display:flex; flex-direction:column; align-items:center;}
    textarea{width:100%; min-height:320px; resize:vertical; font-family:monospace; font-size:16px; color:var(--text); background:var(--card); border:1px solid #2b2b2b; padding:12px; border-radius:6px; box-sizing:border-box;}
    .centerButton{display:flex; justify-content:center; margin-top:12px;}
    button.primary{padding:14px 26px; font-size:18px; border-radius:8px; background:#2f6b2f; border:none; color:white; cursor:pointer;}
    button.primary:hover{background:#3f8b3f}
    .pilot-controls{width:100%; margin-top:12px;}
    .pilot-row{display:flex; gap:8px; align-items:center; margin-bottom:8px;}
    .pilot-row input[type=number], .pilot-row input[type=text]{width:140px; padding:8px; border-radius:6px; border:1px solid #2b2b2b; background:var(--card); color:var(--text);}
    .pilot-row label{flex:1; font-size:14px;}
    .pilot-actions{display:flex; gap:8px; align-items:center;}
    .small{font-size:13px; color:var(--muted);}
    .summary{width:100%; margin-top:12px; font-weight:600; font-size:14px;}
    ul.quality{list-style:none; padding:0; margin:0;}
    ul.quality li{padding:6px 0;}
    .green{color:var(--accent);}
    .orange{color:var(--orange);}
    .muted{color:var(--muted);}
    .results-box{width:100%; max-width:1100px;}
    .mineral-list{list-style:none; padding:0; margin:0;}
    .mineral-item{padding:10px; border:1px solid #212121; margin-bottom:8px; border-radius:6px; background:#121212;}
    .mineral-header{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .mineral-name{font-weight:700; color:var(--text); margin-right:8px;}
    .variant-prefix{opacity:0.9; margin-right:6px; color:var(--muted);}
    .mini{font-size:13px; color:var(--muted);}
    .raw-list{margin-top:8px; display:flex; gap:12px; flex-wrap:wrap;}
    .raw-item{background:#161616; border:1px solid #222; padding:6px 8px; border-radius:6px; font-size:13px; color:var(--default-raw);}
    .raw-tritanium{color:var(--tritanium); font-weight:700;}
    .raw-pyerite{color:var(--pyerite); font-weight:700;}
    .raw-nocxium{color:var(--nocxium); font-weight:700;}
    .raw-mexallon{color:var(--mexallon); font-weight:700;}
    .raw-megacyte{color:var(--megacyte); font-weight:700;}
    .raw-isogen{color:var(--isogen); font-weight:700;}
    .raw-morphite{color:var(--morphite); font-weight:700;}
    .raw-zydrine{color:var(--zydrine); font-weight:700;}
    .global-raw{display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;}
    .global-raw .raw-item{background:#232323;}
    @media (min-width:1920px){ .cols{flex-direction:row;} .left textarea{min-height:calc(100vh - 220px);} }
    @media (max-width:1919px){ .cols{flex-direction:column;} }
    .controls-row{display:flex; gap:8px; flex-wrap:wrap; align-items:center;margin-top:8px;}
    .btn-ghost{background:transparent;border:1px solid #333;color:var(--text);padding:6px 10px;border-radius:6px;cursor:pointer;}
    .btn-danger{background:#8b2b2b;border:none;color:white;padding:6px 10px;border-radius:6px;cursor:pointer;}
    .meta{font-size:13px;color:var(--muted);margin-top:8px;}
    .pilot-table{width:100%; margin-top:12px; border-collapse:collapse;}
    .pilot-table th, .pilot-table td{border:1px solid #222; padding:6px;}
    .hint{font-size:12px;color:var(--muted); margin-top:8px;}
  </style>
</head>
<body>
  <div class="app">
    <h1 style="margin:0 0 4px 0">Escaneo de Belt â€” EVE Online V1.2</h1>
    <div class="cols">
      <div class="left" id="leftPanel">
        <h3 style="margin:0 0 8px 0">Pega tu escaneo</h3>
        <textarea id="scanInput" placeholder="Pega aquÃ­ el escaneo. Ejemplo:
Augmented Eifyrium    29.000    464.000 m3    31 km
Boosted Eifyrium    28.000    448.000 m3    37 km
..."></textarea>

        <div class="centerButton" style="margin-top:10px;">
          <button class="primary" id="runBtn">ðŸ”„ Activar compresiÃ³n</button>
        </div>

        <div class="pilot-controls" aria-label="Gestor de pilotos">
          <h4 style="margin:10px 0 8px 0">Pilotos (editable)</h4>
          <div id="pilotList"></div>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button class="btn-ghost" id="addPilotBtn">âž• AÃ±adir piloto</button>
            <button class="btn-ghost" id="removePilotBtn">âž– Quitar piloto</button>
            <div class="small" style="margin-left:auto">Total rendimiento: <span id="totalRate">â€”</span> mÂ³/min</div>
          </div>
          <div class="meta">Cada piloto tiene nombre editable y mÂ³/min. Por defecto 4 pilotos a 1500 mÂ³/min.</div>
          <div class="hint">Edita refineMap en el script para ajustar yields por unidad de ore.</div>
        </div>
      </div>

      <div class="right" id="rightPanel">
        <div id="resultsContainer" class="results-box"></div>
      </div>
    </div>
  </div>

  <script>
    /**************************************************************************
     * Mapeos configurables: refineMap define yields por unidad de ore
     **************************************************************************/
    const refineMap = {
      'Bistot':   { 'Tritanium': 0.0,  'Pyerite': 0.0,   'Mexallon': 0.2,  'Nocxium': 0.05, 'Zydrine': 0.01 },
      'Eifyrium': { 'Tritanium': 0.05, 'Pyerite': 0.0,   'Mexallon': 0.3,  'Nocxium': 0.08, 'Isogen': 0.02 },
      'Hezorime': { 'Tritanium': 0.02, 'Pyerite': 0.0,   'Mexallon': 0.25, 'Nocxium': 0.07, 'Zydrine': 0.03 },
      // aÃ±ade mÃ¡s ores si es necesario
    };

    const compressionRatios = { 'Bistot':0.01, 'Eifyrium':0.01, 'Hezorime':0.01 };
    const compressedPrices = { 'Bistot':8000, 'Eifyrium':12000, 'Hezorime':9500 };

    // Utils y parseo
    function normalizeName(name){ return name.replace(/^(Augmented|Boosted|Cubic|Doped|Dull|Sharp|Serrated|Monoclinic|Triclinic)\s+/i,'').trim(); }
    function extractVariant(name){ const m = name.match(/^(Augmented|Boosted|Cubic|Doped|Dull|Sharp|Serrated|Monoclinic|Triclinic)\b/i); return m ? m[0] : ''; }
    function classifyQuality(name){
      if(/^(Augmented|Boosted|Serrated|Sharp)/i.test(name)) return 'Muy bueno';
      if(/^(Cubic|Doped|Monoclinic|Triclinic)/i.test(name)) return 'Bueno';
      return 'Normal';
    }

    function parseScan(text){
      if(!text) return [];
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
      const ores = [];
      for(const line of lines){
        const parts = line.split(/\s{2,}|\t/).map(p=>p.trim()).filter(p=>p!=='');
        let rawName='', qtyRaw='0', volRaw='0', distRaw='';
        if(parts.length>=3){
          rawName = parts[0];
          qtyRaw = parts[1];
          volRaw = parts[2];
          distRaw = parts[3] || '';
        } else {
          const tokens = line.split(/\s+/);
          if(tokens.length>=4){
            rawName = tokens.slice(0,tokens.length-3).join(' ');
            qtyRaw = tokens[tokens.length-3];
            volRaw = tokens[tokens.length-2];
            distRaw = tokens[tokens.length-1];
          } else continue;
        }
        const qty = parseFloat(qtyRaw.replace(/\./g,'').replace(/,/g,'.')) || 0;
        const volNum = parseFloat((volRaw||'').replace(/[^\d,\.]/g,'').replace(/\./g,'').replace(/,/g,'.')) || 0;
        const distNum = parseFloat((distRaw||'').replace(/[^\d,\.]/g,'').replace(/\./g,'').replace(/,/g,'.')) || 0;
        const variant = extractVariant(rawName);
        const base = normalizeName(rawName);
        ores.push({
          rawName,
          variant,
          base,
          labelVariant: variant ? variant : 'Normal',
          fullLabel: (variant ? variant : 'Normal') + ' ' + base,
          quality: classifyQuality(rawName),
          quantity: qty,
          volume: volNum,
          distance: distNum
        });
      }
      return ores;
    }

    function compressVolume(ore){ const ratio = compressionRatios[ore.base] || 0; return ore.quantity * ratio; }
    function estimatePrice(ore){ const per = compressedPrices[ore.base] || 0; return compressVolume(ore) * per; }

    // Pilots UI
    const pilotListEl = document.getElementById('pilotList');
    const totalRateEl = document.getElementById('totalRate');

    function createPilotRow(name='', rate=1500){
      const wrapper = document.createElement('div');
      wrapper.className = 'pilot-row';
      wrapper.innerHTML = `
        <label style="flex:1"><input type="text" class="pilot-name" value="${escapeAttr(name||'Piloto')}" style="width:140px; padding:6px; margin-right:8px;" /> </label>
        <label class="small">mÂ³/min <input type="number" class="pilot-rate" value="${rate}" min="1" /></label>
        <div class="pilot-actions">
          <button class="btn-ghost btn-copy" title="Copiar valor">Copiar</button>
        </div>
      `;
      wrapper.querySelector('.btn-copy').addEventListener('click', ()=> {
        const v = wrapper.querySelector('.pilot-rate').value;
        navigator.clipboard?.writeText(v).catch(()=>{});
      });
      wrapper.querySelector('.pilot-rate').addEventListener('input', updateTotalRate);
      return wrapper;
    }

    function addPilot(name='Piloto', rate=1500){
      pilotListEl.appendChild(createPilotRow(name, rate));
      refreshPilotNames();
      updateTotalRate();
    }
    function removePilot(){
      if(pilotListEl.children.length>1) pilotListEl.removeChild(pilotListEl.lastElementChild);
      refreshPilotNames();
      updateTotalRate();
    }
    function refreshPilotNames(){
      Array.from(pilotListEl.children).forEach((row,i)=>{
        const nameInput = row.querySelector('.pilot-name');
        if(!nameInput.value) nameInput.value = `Piloto ${i+1}`;
      });
    }
    function getPilotData(){
      const rows = Array.from(pilotListEl.children);
      return rows.map((row,i)=>{
        const name = row.querySelector('.pilot-name').value || `Piloto ${i+1}`;
        const rate = parseFloat(row.querySelector('.pilot-rate').value) || 0;
        return { name, rate };
      });
    }
    function getTotalRate(){ return getPilotData().reduce((s,p)=>s+p.rate,0); }
    function updateTotalRate(){ totalRateEl.textContent = getTotalRate().toLocaleString(); }

    // Render
    const resultsContainer = document.getElementById('resultsContainer');
    function renderResults(html){ resultsContainer.innerHTML = html; if(window.innerWidth < 1200) resultsContainer.scrollIntoView({behavior:'smooth'}); }

    // Raw calc helpers
    function calcRawFor(item){
      const map = refineMap[item.base];
      if(!map) return {};
      const out = {};
      Object.keys(map).forEach(rm => { out[rm] = map[rm] * item.quantity; });
      return out;
    }
    function formatNumber(n){
      const isInt = Math.abs(n - Math.round(n)) < 0.0001;
      return isInt ? Math.round(n).toLocaleString() : n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    function rawClassFor(name){
      const n = (name || '').toLowerCase();
      if(n === 'tritanium') return 'raw-tritanium';
      if(n === 'pyerite') return 'raw-pyerite';
      if(n === 'nocxium' || n === 'noxcium' || n === 'nocx') return 'raw-nocxium';
      if(n === 'mexallon' || n.includes('mexall')) return 'raw-mexallon';
      if(n === 'megacyte' || n.includes('megacyt')) return 'raw-megacyte';
      if(n === 'isogen' || n.includes('isog')) return 'raw-isogen';
      if(n === 'morphite' || n.includes('morph')) return 'raw-morphite';
      if(n === 'zydrine' || n.includes('zydr')) return 'raw-zydrine';
      return '';
    }

    function processScan(){
      const text = document.getElementById('scanInput').value;
      const ores = parseScan(text);
      if(ores.length===0){ renderResults(`<div class="muted">No hay datos para procesar.</div>`); return; }

      const byLabel = {};
      let totalVolume = 0, totalCompressed = 0, totalPrice = 0;
      const qualityStats = { 'Muy bueno':{volume:0,price:0}, 'Bueno':{volume:0,price:0}, 'Normal':{volume:0,price:0} };
      const globalRawTotals = {};

      ores.forEach(o=>{
        totalVolume += o.volume;
        const comp = compressVolume(o);
        const price = estimatePrice(o);
        totalCompressed += comp;
        totalPrice += price;

        const key = o.fullLabel;
        if(!byLabel[key]) byLabel[key] = { label:o.fullLabel, base:o.base, variant:o.variant ? o.variant : 'Normal', quantity:0, volume:0, compressed:0, price:0, quality:o.quality, rawBreakdown: {} };
        byLabel[key].quantity += o.quantity;
        byLabel[key].volume += o.volume;
        byLabel[key].compressed += comp;
        byLabel[key].price += price;

        const rawForLine = calcRawFor(o);
        Object.keys(rawForLine).forEach(rm=>{
          byLabel[key].rawBreakdown[rm] = (byLabel[key].rawBreakdown[rm] || 0) + rawForLine[rm];
          globalRawTotals[rm] = (globalRawTotals[rm] || 0) + rawForLine[rm];
        });

        qualityStats[o.quality].volume += o.volume;
        qualityStats[o.quality].price += price;
      });

      // Build HTML list
      let html = `<div><h3>Desglose simplificado (Variante + Mineral)</h3><ul class="mineral-list">`;
      Object.values(byLabel).forEach(item=>{
        const variantText = item.variant === 'Normal' ? 'Normal' : item.variant;
        const display = `${variantText} <strong>${escape(item.base)}</strong>`;
        const qualityBadge = item.quality==='Muy bueno' ? '<span class="green">ðŸŸ© Muy bueno</span>' : item.quality==='Bueno' ? '<span class="orange">ðŸŸ§ Bueno</span>' : '<span class="muted">âšª Normal</span>';

        html += `<li class="mineral-item">
          <div class="mineral-header">
            <div style="flex:1">${display}</div>
            <div class="mini">${qualityBadge}</div>
          </div>
          <div class="mini" style="margin-top:8px;">
            Cantidad: <strong>${item.quantity.toLocaleString()}</strong> Â· Volumen: <strong>${item.volume.toLocaleString()} mÂ³</strong> Â· Comprimido: <strong>${item.compressed.toLocaleString()} mÂ³</strong> Â· ISK estimado: <strong>${Math.round(item.price).toLocaleString()} ISK</strong>
          </div>`;

        if(Object.keys(item.rawBreakdown).length>0){
          html += `<div class="raw-list">`;
          Object.keys(item.rawBreakdown).forEach(rm=>{
            const cls = rawClassFor(rm);
            html += `<div class="raw-item ${cls}">${escape(rm)}: <strong>${formatNumber(item.rawBreakdown[rm])}</strong></div>`;
          });
          html += `</div>`;
        } else {
          html += `<div class="mini" style="margin-top:8px;color:#a0a0a0">No hay mapa de conversiÃ³n para <strong>${escape(item.base)}</strong>. AÃ±Ã¡delo en refineMap del script.</div>`;
        }

        html += `</li>`;
      });
      html += `</ul>`;

      // Totals
      const totalRate = getTotalRate() || 1;
      const timeMinutes = totalVolume / totalRate;
      html += `<div class="summary">
        Volumen total original: ${totalVolume.toLocaleString()} mÂ³<br>
        Volumen total comprimido: ${totalCompressed.toLocaleString()} mÂ³<br>
        Precio estimado total: ${Math.round(totalPrice).toLocaleString()} ISK<br>
        Tiempo estimado de minado: <strong>${timeMinutes.toFixed(1)}</strong> minutos (Rendimiento total: ${totalRate.toLocaleString()} mÂ³/min)
      </div>`;

      // Quality breakdown
      html += `<div class="summary" style="margin-top:12px;"><h4 style="margin:6px 0">Desglose por calidad</h4><ul class="quality">
        ${renderQualityLine('Muy bueno', qualityStats['Muy bueno'], totalVolume, totalPrice)}
        ${renderQualityLine('Bueno', qualityStats['Bueno'], totalVolume, totalPrice)}
        ${renderQualityLine('Normal', qualityStats['Normal'], totalVolume, totalPrice)}
      </ul></div>`;

      // Per-pilot breakdown
      const pilots = getPilotData();
      html += `<div class="summary" style="margin-top:12px;"><h4 style="margin:6px 0">Desglose por piloto (segÃºn rendimiento)</h4>
        <table class="pilot-table"><thead><tr><th>Piloto</th><th>mÂ³/min</th><th>ParticipaciÃ³n</th><th>Volumen minado estimado</th><th>ISK estimado</th></tr></thead><tbody>`;
      pilots.forEach(p=>{
        const totalRateVal = getTotalRate() || 1;
        const share = totalRateVal>0 ? (p.rate / totalRateVal) : 0;
        const vol = totalVolume * share;
        const isk = Math.round(totalPrice * share);
        html += `<tr>
          <td>${escape(p.name)}</td>
          <td>${p.rate.toLocaleString()} mÂ³/min</td>
          <td>${(share*100).toFixed(2)}%</td>
          <td>${vol.toLocaleString()} mÂ³</td>
          <td>${isk.toLocaleString()} ISK</td>
        </tr>`;
      });
      html += `</tbody></table></div>`;

      // Global raw totals (ordered)
      html += `<div class="summary" style="margin-top:12px;"><h4 style="margin:6px 0">Totales de raw minerals</h4>`;
      if(Object.keys(globalRawTotals).length>0){
        html += `<div class="global-raw">`;
        const order = ['Tritanium','Pyerite','Nocxium','Mexallon','Megacyte','Isogen','Morphite','Zydrine'];
        const seen = new Set();
        order.forEach(k=>{
          if(globalRawTotals[k] !== undefined){
            const cls = rawClassFor(k);
            html += `<div class="raw-item ${cls}">${escape(k)}: <strong>${formatNumber(globalRawTotals[k])}</strong></div>`;
            seen.add(k);
          }
        });
        Object.keys(globalRawTotals).forEach(k=>{
          if(!seen.has(k)){
            const cls = rawClassFor(k);
            html += `<div class="raw-item ${cls}">${escape(k)}: <strong>${formatNumber(globalRawTotals[k])}</strong></div>`;
          }
        });
        html += `</div>`;
      } else {
        html += `<div class="mini">No se han generado raw minerals (aÃ±ade mappings en refineMap).</div>`;
      }
      html += `</div>`;

      renderResults(html);
    }

    function renderQualityLine(name, stats, totalVol, totalPrice){
      const vol = stats?.volume || 0;
      const price = stats?.price || 0;
      const volPct = totalVol? (vol/totalVol*100):0;
      const pricePct = totalPrice? (price/totalPrice*100):0;
      const cls = name==='Muy bueno' ? 'green' : (name==='Bueno' ? 'orange' : 'muted');
      const icon = name==='Muy bueno' ? 'ðŸŸ©' : (name==='Bueno' ? 'ðŸŸ§' : 'âšª');
      return `<li class="${cls}">${icon} ${name}: ${vol.toLocaleString()} mÂ³ (${volPct.toFixed(1)}%) â†’ ${Math.round(price).toLocaleString()} ISK (${pricePct.toFixed(1)}%)</li>`;
    }

    function escape(s){ return (s+'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function escapeAttr(s){ return (s+'').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

    // UI bindings
    document.getElementById('addPilotBtn').addEventListener('click', ()=>addPilot('Piloto',1500));
    document.getElementById('removePilotBtn').addEventListener('click', removePilot);
    document.getElementById('runBtn').addEventListener('click', processScan);

    // Pilot helpers
    function getPilotData(){ return Array.from(pilotListEl.children).map((row,i)=>({ name: row.querySelector('.pilot-name').value||`Piloto ${i+1}`, rate: parseFloat(row.querySelector('.pilot-rate').value)||0 })); }
    function getTotalRate(){ return getPilotData().reduce((s,p)=>s+p.rate,0); }
    function updateTotalRate(){ totalRateEl.textContent = getTotalRate().toLocaleString(); }

    function createPilotRowSimple(name='', rate=1500){
      const wrapper = document.createElement('div');
      wrapper.className = 'pilot-row';
      wrapper.innerHTML = `
        <label style="flex:1"><input type="text" class="pilot-name" value="${escapeAttr(name||'Piloto')}" style="width:140px; padding:6px; margin-right:8px;" /> </label>
        <label class="small">mÂ³/min <input type="number" class="pilot-rate" value="${rate}" min="1" /></label>
        <div class="pilot-actions"><button class="btn-ghost btn-copy">Copiar</button></div>
      `;
      wrapper.querySelector('.btn-copy').addEventListener('click', ()=> navigator.clipboard?.writeText(wrapper.querySelector('.pilot-rate').value).catch(()=>{}));
      wrapper.querySelector('.pilot-rate').addEventListener('input', updateTotalRate);
      return wrapper;
    }
    function addPilot(name='Piloto', rate=1500){ pilotListEl.appendChild(createPilotRowSimple(name, rate)); refreshPilotNames(); updateTotalRate(); }
    function removePilot(){ if(pilotListEl.children.length>1) pilotListEl.removeChild(pilotListEl.lastElementChild); refreshPilotNames(); updateTotalRate(); }
    function refreshPilotNames(){ Array.from(pilotListEl.children).forEach((r,i)=>{ const n=r.querySelector('.pilot-name'); if(!n.value) n.value=`Piloto ${i+1}`; }); }

    // init 4 pilotos
    addPilot('Alpha',1500); addPilot('Bravo',1500); addPilot('Charlie',1500); addPilot('Delta',1500);
    updateTotalRate();

    // shortcut Ctrl+Enter
    document.getElementById('scanInput').addEventListener('keydown', e=>{ if(e.ctrlKey && e.key.toLowerCase()==='enter') processScan(); });
  </script>
</body>
</html>
