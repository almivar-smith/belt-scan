<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Escaneo de Belt - EVE Online</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f0f10; --panel:#161616; --muted:#9ea1a4; --accent:#4caf50; --orange:#ff9800; --card:#1c1c1c;
      --text:#e9eef2;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;}
    .app{box-sizing:border-box; padding:18px; display:flex; flex-direction:column; gap:16px; min-height:100vh;}
    /* layout: desktop splits, small stacks */
    .cols{display:flex; gap:16px;}
    .left,.right{background:var(--panel); border:1px solid #222; border-radius:8px; padding:14px; box-sizing:border-box;}
    .left{flex:1 1 50%; min-width:320px;}
    .right{flex:1 1 50%; min-width:320px; display:flex; flex-direction:column; align-items:center;}
    textarea{width:100%; min-height:320px; resize:vertical; font-family:monospace; font-size:16px; color:var(--text); background:var(--card); border:1px solid #2b2b2b; padding:12px; border-radius:6px; box-sizing:border-box;}
    .centerButton{display:flex; justify-content:center; margin-top:12px;}
    button.primary{padding:14px 26px; font-size:18px; border-radius:8px; background:#2f6b2f; border:none; color:white; cursor:pointer;}
    button.primary:hover{background:#3f8b3f}
    .pilot-controls{width:100%; margin-top:12px;}
    .pilot-row{display:flex; gap:8px; align-items:center; margin-bottom:8px;}
    .pilot-row input[type=number]{width:120px; padding:8px; border-radius:6px; border:1px solid #2b2b2b; background:var(--card); color:var(--text);}
    .pilot-row label{flex:1; font-size:14px;}
    .pilot-actions{display:flex; gap:8px; align-items:center;}
    .small{font-size:13px; color:var(--muted);}
    table{width:100%; border-collapse:collapse; margin-top:12px;}
    th,td{border:1px solid #222; padding:8px; text-align:left; font-size:13px;}
    th{background:#111;}
    .summary{width:100%; margin-top:12px; font-weight:600; font-size:14px;}
    ul.quality{list-style:none; padding:0; margin:0;}
    ul.quality li{padding:6px 0;}
    .green{color:var(--accent);}
    .orange{color:var(--orange);}
    .muted{color:var(--muted);}
    /* responsive behaviour: if viewport narrower than 1920 stack, else two columns */
    @media (min-width:1920px){
      .cols{flex-direction:row;}
      .left{order:0}
      .right{order:1}
      .left textarea{min-height:calc(100vh - 220px);}
    }
    @media (max-width:1919px){
      .cols{flex-direction:column;}
      .left{order:0}
      .right{order:1}
      .centerButton{order:1}
    }
    .controls-row{display:flex; gap:8px; flex-wrap:wrap; align-items:center;margin-top:8px;}
    .btn-ghost{background:transparent;border:1px solid #333;color:var(--text);padding:6px 10px;border-radius:6px;cursor:pointer;}
    .btn-danger{background:#8b2b2b;border:none;color:white;padding:6px 10px;border-radius:6px;cursor:pointer;}
    .meta{font-size:13px;color:var(--muted);margin-top:8px;}
  </style>
</head>
<body>
  <div class="app">
    <h1 style="margin:0 0 4px 0">Escaneo de Belt â€” EVE Online</h1>
    <div class="cols">
      <div class="left" id="leftPanel">
        <h3 style="margin:0 0 8px 0">Pega tu escaneo</h3>
        <textarea id="scanInput" placeholder="Pega aquÃ­ el escaneo. Ejemplo:
Augmented Eifyrium    29.000    464.000 m3    31 km
Bistot    30.000    480.000 m3    32 km
..."></textarea>

        <div class="centerButton" style="margin-top:10px;">
          <button class="primary" id="runBtn">ðŸ”„ Activar compresiÃ³n</button>
        </div>

        <div class="pilot-controls" aria-label="Gestor de pilotos">
          <h4 style="margin:10px 0 8px 0">Pilotos (editable)</h4>
          <div id="pilotList"></div>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button class="btn-ghost" id="addPilotBtn">âž• AÃ±adir piloto</button>
            <button class="btn-ghost" id="removePilotBtn">âž– Quitar piloto</button>
            <div class="small" style="margin-left:auto">Total rendimiento: <span id="totalRate">â€”</span> mÂ³/min</div>
          </div>
          <div class="meta">Cada piloto tiene su campo mÂ³/min. Por defecto 4 pilotos a 1500 mÂ³/min.</div>
        </div>
      </div>

      <div class="right" id="rightPanel">
        <div id="resultsContainer" style="width:100%; max-width:1100px;"></div>
      </div>
    </div>
  </div>

  <script>
    // --- Configurables (ajusta precios/ratios aquÃ­) ---
    const compressionRatios = { 'Bistot':0.01, 'Eifyrium':0.01, 'Hezorime':0.01 };
    const compressedPrices = { 'Bistot':8000, 'Eifyrium':12000, 'Hezorime':9500 };

    // --- util: limpiar y normalizar ---
    function normalizeName(name){
      return name.replace(/^(Augmented|Boosted|Cubic|Doped|Dull|Sharp|Serrated|Monoclinic|Triclinic)\s+/i,'').trim();
    }
    function classifyQuality(name){
      if(/^(Augmented|Boosted|Serrated|Sharp)/i.test(name)) return 'Muy bueno';
      if(/^(Cubic|Doped|Monoclinic|Triclinic)/i.test(name)) return 'Bueno';
      return 'Normal';
    }

    // --- parsing robusto por lÃ­nea ---
    function parseScan(text){
      if(!text) return [];
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
      const ores = [];
      for(const line of lines){
        // intenta capturar: nombre [espacios dobles] cantidad [espacios] volumen m3 [espacios] distancia km
        // split por 2+ espacios o tab
        const parts = line.split(/\s{2,}|\t/).map(p=>p.trim()).filter(p=>p!=='');
        if(parts.length < 3){
          // fallback: split por espacios y reconstruir
          const tokens = line.split(/\s+/);
          // heurÃ­stica: distancia termina en km
          let distTok = tokens[tokens.length-1];
          let volTok = tokens[tokens.length-2];
          let qtyTok = tokens[tokens.length-3];
          const nameTok = tokens.slice(0,tokens.length-3).join(' ');
          parts.length=0;
          parts.push(nameTok, qtyTok, volTok, distTok);
        } else if(parts.length===3){
          // quizÃ¡ falta distancia, ignÃ³ralo
          parts.push('');
        }
        // Normalizar nÃºmeros: aceptar 29.000 o 29,000 o 29000 etc.
        const rawName = parts[0];
        const qtyRaw = parts[1] || '0';
        const volRaw = parts[2] || '0';
        const distRaw = parts[3] || '';
        const qty = parseFloat(qtyRaw.replace(/\./g,'').replace(/,/g,'.')) || 0;
        // volumen puede venir "464.000 m3" o "464000 m3"
        const volNum = parseFloat((volRaw||'').replace(/[^\d,\.]/g,'').replace(/\./g,'').replace(/,/g,'.')) || 0;
        const distNum = parseFloat((distRaw||'').replace(/[^\d,\.]/g,'').replace(/\./g,'').replace(/,/g,'.')) || 0;
        ores.push({
          name: rawName,
          baseName: normalizeName(rawName),
          quality: classifyQuality(rawName),
          quantity: qty,
          volume: volNum,
          distance: distNum
        });
      }
      return ores;
    }

    function compressVolume(ore){
      const ratio = compressionRatios[ore.baseName] || 0;
      // Si ratio 0 significa que no se comprime (o desconocido) -> usar volumen/1000? aquÃ­ usamos quantity*ratio per spec
      return ore.quantity * ratio;
    }
    function estimatePrice(ore){
      const per = compressedPrices[ore.baseName] || 0;
      return compressVolume(ore) * per;
    }

    // --- Pilotos management ---
    const pilotListEl = document.getElementById('pilotList');
    const totalRateEl = document.getElementById('totalRate');
    function createPilotRow(value){
      const wrapper = document.createElement('div');
      wrapper.className = 'pilot-row';
      const index = pilotListEl.children.length + 1;
      wrapper.innerHTML = `
        <label>Piloto ${index}: <input type="number" class="pilot-rate" value="${value}" min="1" /></label>
        <div class="pilot-actions">
          <button class="btn-ghost btn-copy" title="Copiar este valor">Copiar</button>
        </div>
      `;
      // acciones
      wrapper.querySelector('.btn-copy').addEventListener('click', ()=> {
        const v = wrapper.querySelector('input').value;
        navigator.clipboard?.writeText(v).catch(()=>{});
      });
      wrapper.querySelector('input').addEventListener('input', updateTotalRate);
      return wrapper;
    }
    function addPilot(value=1500){
      pilotListEl.appendChild(createPilotRow(value));
      refreshPilotLabels();
      updateTotalRate();
    }
    function removePilot(){
      if(pilotListEl.children.length>1) pilotListEl.removeChild(pilotListEl.lastElementChild);
      refreshPilotLabels();
      updateTotalRate();
    }
    function refreshPilotLabels(){
      Array.from(pilotListEl.children).forEach((row,i)=>{
        const lbl = row.querySelector('label');
        if(lbl) lbl.childNodes[0].textContent = `Piloto ${i+1}: `;
      });
    }
    function getTotalRate(){
      let total=0;
      const inputs = pilotListEl.querySelectorAll('input.pilot-rate');
      inputs.forEach(i=> total += (parseFloat(i.value)||0));
      return total;
    }
    function updateTotalRate(){
      totalRateEl.textContent = getTotalRate().toLocaleString();
    }

    // --- Results render ---
    const resultsContainer = document.getElementById('resultsContainer');
    function renderResults(html){
      resultsContainer.innerHTML = html;
      // scroll to results on small screens
      if(window.innerWidth < 1200) resultsContainer.scrollIntoView({behavior:'smooth'});
    }

    function processScan(){
      const text = document.getElementById('scanInput').value;
      const ores = parseScan(text);
      if(ores.length===0){
        renderResults(`<div class="muted">No hay datos para procesar.</div>`);
        return;
      }
      // aggregates
      let totalVolume = 0;
      let totalCompressed = 0;
      let totalPrice = 0;
      const byName = {};
      const qualityStats = { 'Muy bueno':{volume:0,price:0}, 'Bueno':{volume:0,price:0}, 'Normal':{volume:0,price:0} };

      ores.forEach(o=>{
        totalVolume += o.volume;
        const comp = compressVolume(o);
        const price = estimatePrice(o);
        totalCompressed += comp;
        totalPrice += price;

        // aggregate by baseName
        const key = o.baseName || o.name;
        if(!byName[key]) byName[key] = { baseName:key, entries:[], quantity:0, volume:0, compressed:0, price:0, quality:o.quality };
        byName[key].entries.push(o);
        byName[key].quantity += o.quantity;
        byName[key].volume += o.volume;
        byName[key].compressed += comp;
        byName[key].price += price;

        // quality totals
        if(!qualityStats[o.quality]) qualityStats[o.quality] = {volume:0,price:0};
        qualityStats[o.quality].volume += o.volume;
        qualityStats[o.quality].price += price;
      });

      // table header
      let html = `<div style="width:100%"><table><thead><tr>
        <th>Mineral</th><th>Cantidad</th><th>Volumen total</th><th>Comprimido (cubos)</th><th>Precio estimado</th><th>Calidad</th>
      </tr></thead><tbody>`;

      Object.values(byName).forEach(b=>{
        html += `<tr>
          <td>${escapeHtml(b.baseName)}</td>
          <td>${b.quantity.toLocaleString()}</td>
          <td>${b.volume.toLocaleString()} mÂ³</td>
          <td>${b.compressed.toLocaleString()} mÂ³</td>
          <td>${Math.round(b.price).toLocaleString()} ISK</td>
          <td class="${b.quality==='Muy bueno'?'green': b.quality==='Bueno'?'orange':'muted'}">${b.quality}</td>
        </tr>`;
      });

      html += `</tbody></table>`;

      // summary and timings
      const totalRate = getTotalRate() || 1;
      const timeMinutes = totalVolume / totalRate;
      html += `<div class="summary">
        Volumen total original: ${totalVolume.toLocaleString()} mÂ³<br>
        Volumen total comprimido: ${totalCompressed.toLocaleString()} mÂ³<br>
        Precio estimado total: ${Math.round(totalPrice).toLocaleString()} ISK<br>
        Tiempo estimado de minado: <strong>${timeMinutes.toFixed(1)}</strong> minutos (Rendimiento total: ${totalRate.toLocaleString()} mÂ³/min)
      </div>`;

      // quality breakdown with percentages
      html += `<div class="summary" style="margin-top:12px;"><h4 style="margin:6px 0">Desglose por calidad</h4>
        <ul class="quality">
          ${renderQualityLine('Muy bueno', qualityStats['Muy bueno'], totalVolume, totalPrice)}
          ${renderQualityLine('Bueno', qualityStats['Bueno'], totalVolume, totalPrice)}
          ${renderQualityLine('Normal', qualityStats['Normal'], totalVolume, totalPrice)}
        </ul>
      </div>`;

      html += `</div>`;
      renderResults(html);
    }

    function renderQualityLine(name, stats, totalVol, totalPrice){
      const vol = stats?.volume || 0;
      const price = stats?.price || 0;
      const volPct = totalVol? (vol/totalVol*100):0;
      const pricePct = totalPrice? (price/totalPrice*100):0;
      const cls = name==='Muy bueno' ? 'green' : (name==='Bueno' ? 'orange' : 'muted');
      const icon = name==='Muy bueno' ? 'ðŸŸ©' : (name==='Bueno' ? 'ðŸŸ§' : 'âšª');
      return `<li class="${cls}">${icon} ${name}: ${vol.toLocaleString()} mÂ³ (${volPct.toFixed(1)}%) â†’ ${Math.round(price).toLocaleString()} ISK (${pricePct.toFixed(1)}%)</li>`;
    }

    function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // --- Bind UI ---
    document.getElementById('addPilotBtn').addEventListener('click', ()=>addPilot(1500));
    document.getElementById('removePilotBtn').addEventListener('click', removePilot);
    document.getElementById('runBtn').addEventListener('click', processScan);

    // init 4 pilotos por defecto
    for(let i=0;i<4;i++) addPilot(1500);

    // update total rate on load
    updateTotalRate();

    // adjust layout on resize: if width >=1920 keep two columns (handled by CSS), else stack (handled by CSS)
    window.addEventListener('resize', ()=>{ /* no-op: CSS handles layout */ });

    // allow paste with ctrl+v focus
    document.getElementById('scanInput').addEventListener('keydown', (e)=>{
      if(e.ctrlKey && e.key.toLowerCase()==='enter'){
        processScan();
      }
    });
  </script>
</body>
</html>
